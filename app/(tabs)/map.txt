import React, { useState, useEffect, useRef, useMemo } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ActivityIndicator,
  TouchableOpacity,
  Alert,
  Platform,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { router } from 'expo-router';
import { useFavorites } from '../../contexts/FavoritesContext';
import { getBusinesses } from '../../api/business';
import type { Business } from '@/types/api';

// Conditional import: tylko na native (iOS/Android), nie na web
let MapView: any = null;
let Marker: any = null;
let PROVIDER_GOOGLE: any = null;
let Location: any = null;

if (Platform.OS !== 'web') {
  const Maps = require('react-native-maps');
  MapView = Maps.default;
  Marker = Maps.Marker;
  PROVIDER_GOOGLE = Maps.PROVIDER_GOOGLE;
  Location = require('expo-location');
}

type Region = {
  latitude: number;
  longitude: number;
  latitudeDelta: number;
  longitudeDelta: number;
};

export default function MapScreen() {
  const [businesses, setBusinesses] = useState<Business[]>([]);
  const [loading, setLoading] = useState(true);
  const [userLocation, setUserLocation] = useState<any>(null);
  const [hasLocationPermission, setHasLocationPermission] = useState(false);
  const mapRef = useRef<any>(null);
  const { favorites } = useFavorites();

  // Web fallback: show message that maps don't work on web
  if (Platform.OS === 'web') {
    return (
      <View style={styles.webContainer}>
        <Ionicons name="map-outline" size={80} color="#FF6B35" />
        <Text style={styles.webTitle}>Mapa dostępna tylko w aplikacji</Text>
        <Text style={styles.webMessage}>
          Mapy Google Maps działają tylko na urządzeniach mobilnych.{'\n'}
          Otwórz aplikację na telefonie, aby zobaczyć mapę z lokalizacjami.
        </Text>
        <View style={styles.webDeviceIcons}>
          <Ionicons name="phone-portrait" size={48} color="#FF6B35" style={{ marginHorizontal: 16 }} />
          <Ionicons name="tablet-portrait" size={56} color="#FF6B35" style={{ marginHorizontal: 16 }} />
        </View>
      </View>
    );
  }

  // Request location permission and get user location
  useEffect(() => {
    if (Platform.OS === 'web' || !Location) return;

    (async () => {
      try {
        const { status } = await Location.requestForegroundPermissionsAsync();
        if (status !== 'granted') {
          Alert.alert(
            'Brak dostępu do lokalizacji',
            'Aby wyświetlić Twoją pozycję na mapie, włącz dostęp do lokalizacji w ustawieniach.'
          );
          setHasLocationPermission(false);
          return;
        }
        setHasLocationPermission(true);
        const location = await Location.getCurrentPositionAsync({});
        setUserLocation(location);
      } catch (error) {
        console.error('Error getting location:', error);
      }
    })();
  }, []);

  // Load businesses
  useEffect(() => {
    loadBusinesses();
  }, []);

  const loadBusinesses = async () => {
    try {
      setLoading(true);
      const data = await getBusinesses();
      setBusinesses(data);
    } catch (error) {
      console.error('Error loading businesses:', error);
      Alert.alert('Błąd', 'Nie udało się załadować lokalizacji');
    } finally {
      setLoading(false);
    }
  };

  // Filter businesses that have valid coordinates
  const businessesWithCoordinates = useMemo(() => {
    return businesses.filter(
      (b) =>
        b.latitude != null &&
        b.longitude != null &&
        !isNaN(b.latitude) &&
        !isNaN(b.longitude)
    );
  }, [businesses]);

  // Calculate initial region to fit all businesses
  const initialRegion = useMemo((): Region | undefined => {
    if (businessesWithCoordinates.length === 0) {
      // Default to Poland center if no businesses
      return {
        latitude: 52.0693,
        longitude: 19.4803,
        latitudeDelta: 8.0,
        longitudeDelta: 8.0,
      };
    }

    const lats = businessesWithCoordinates.map((b) => b.latitude!);
    const lngs = businessesWithCoordinates.map((b) => b.longitude!);

    const minLat = Math.min(...lats);
    const maxLat = Math.max(...lats);
    const minLng = Math.min(...lngs);
    const maxLng = Math.max(...lngs);

    const midLat = (minLat + maxLat) / 2;
    const midLng = (minLng + maxLng) / 2;

    const latDelta = (maxLat - minLat) * 1.5 || 0.1;
    const lngDelta = (maxLng - minLng) * 1.5 || 0.1;

    return {
      latitude: midLat,
      longitude: midLng,
      latitudeDelta: Math.max(latDelta, 0.05),
      longitudeDelta: Math.max(lngDelta, 0.05),
    };
  }, [businessesWithCoordinates]);

  // Handle marker press
  const handleMarkerPress = (business: Business) => {
    router.push(`/business/${business.id}`);
  };

  // Center map on user location
  const centerOnUserLocation = () => {
    if (userLocation && mapRef.current) {
      mapRef.current.animateToRegion({
        latitude: userLocation.coords.latitude,
        longitude: userLocation.coords.longitude,
        latitudeDelta: 0.05,
        longitudeDelta: 0.05,
      });
    }
  };

  if (loading) {
    return (
      <View style={styles.loadingContainer}>
        <ActivityIndicator size="large" color="#FF6B35" />
        <Text style={styles.loadingText}>Ładowanie mapy...</Text>
      </View>
    );
  }

  if (businessesWithCoordinates.length === 0) {
    return (
      <View style={styles.emptyContainer}>
        <Ionicons name="location-outline" size={80} color="#ccc" />
        <Text style={styles.emptyTitle}>Brak lokalizacji</Text>
        <Text style={styles.emptyMessage}>
          Nie znaleziono firm z danymi GPS.
        </Text>
        <TouchableOpacity style={styles.retryButton} onPress={loadBusinesses}>
          <Text style={styles.retryButtonText}>Odśwież</Text>
        </TouchableOpacity>
      </View>
    );
  }

  // Native-only map rendering
  if (!MapView || !Marker) {
    return (
      <View style={styles.emptyContainer}>
        <Ionicons name="warning-outline" size={80} color="#FF6B35" />
        <Text style={styles.emptyTitle}>Błąd mapy</Text>
        <Text style={styles.emptyMessage}>
          Nie można załadować komponentu mapy.
        </Text>
      </View>
    );
  }

  return (
    <View style={styles.container}>
      {/* Business Count Badge */}
      <View style={styles.countBadge}>
        <Ionicons name="business" size={16} color="#FF6B35" />
        <Text style={styles.countText}>{businessesWithCoordinates.length}</Text>
      </View>

      {/* Map */}
      <MapView
        ref={mapRef}
        style={styles.map}
        provider={PROVIDER_GOOGLE}
        initialRegion={initialRegion}
        showsUserLocation={hasLocationPermission}
        showsMyLocationButton={false}
        showsCompass={true}
        showsScale={true}
      >
        {businessesWithCoordinates.map((business) => {
          // Convert business.id to string for favorites comparison
          const businessIdStr = String(business.id);
          const isFavorite = favorites.includes(businessIdStr);
          
          return (
            <Marker
              key={business.id}
              coordinate={{
                latitude: business.latitude!,
                longitude: business.longitude!,
              }}
              title={business.name}
              description={business.address}
              onCalloutPress={() => handleMarkerPress(business)}
              pinColor={isFavorite ? '#FF1744' : '#FF6B35'}
            >
              <View style={styles.markerContainer}>
                {isFavorite && (
                  <Ionicons
                    name="heart"
                    size={16}
                    color="#FF1744"
                    style={styles.markerHeart}
                  />
                )}
                <Ionicons name="location" size={40} color={isFavorite ? '#FF1744' : '#FF6B35'} />
              </View>
            </Marker>
          );
        })}
      </MapView>

      {/* My Location Button */}
      {hasLocationPermission && userLocation && (
        <TouchableOpacity style={styles.myLocationButton} onPress={centerOnUserLocation}>
          <Ionicons name="locate" size={24} color="#FF6B35" />
        </TouchableOpacity>
      )}
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  map: {
    width: '100%',
    height: '100%',
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#fff',
  },
  loadingText: {
    marginTop: 16,
    fontSize: 16,
    color: '#666',
  },
  emptyContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#fff',
    padding: 20,
  },
  emptyTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#333',
    marginTop: 16,
    marginBottom: 8,
  },
  emptyMessage: {
    fontSize: 16,
    color: '#666',
    textAlign: 'center',
    lineHeight: 24,
  },
  retryButton: {
    marginTop: 24,
    backgroundColor: '#FF6B35',
    paddingHorizontal: 32,
    paddingVertical: 12,
    borderRadius: 8,
  },
  retryButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
  },
  countBadge: {
    position: 'absolute',
    top: Platform.OS === 'ios' ? 60 : 16,
    left: 16,
    backgroundColor: '#fff',
    borderRadius: 20,
    paddingHorizontal: 12,
    paddingVertical: 8,
    flexDirection: 'row',
    alignItems: 'center',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 4,
    elevation: 5,
    zIndex: 10,
  },
  countText: {
    marginLeft: 6,
    fontSize: 14,
    fontWeight: '600',
    color: '#333',
  },
  myLocationButton: {
    position: 'absolute',
    bottom: 24,
    right: 16,
    backgroundColor: '#fff',
    width: 56,
    height: 56,
    borderRadius: 28,
    justifyContent: 'center',
    alignItems: 'center',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 4,
    elevation: 5,
  },
  markerContainer: {
    alignItems: 'center',
    justifyContent: 'center',
  },
  markerHeart: {
    position: 'absolute',
    top: -8,
    right: -8,
    zIndex: 1,
  },
  // Web-specific styles
  webContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#fff',
    padding: 32,
  },
  webTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#333',
    marginTop: 24,
    marginBottom: 12,
    textAlign: 'center',
  },
  webMessage: {
    fontSize: 16,
    color: '#666',
    textAlign: 'center',
    lineHeight: 24,
    maxWidth: 400,
  },
  webDeviceIcons: {
    flexDirection: 'row',
    marginTop: 32,
    alignItems: 'center',
  },
});